
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Ka Ka Blog</title>
	<meta name="author" content="kaka">

	
	<meta name="description" content="由于pomelo 依赖node-gyp这modules所以有点麻烦,安装之前配置python环境，官方推荐版本2.7 npm config set python /usr/local/bin/python2.7 npm install -g node-gyp npm install -g &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Ka Ka Blog" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	
	<script src="/javascripts/jquery-1.8.3.js"></script>
<script src="/javascripts/application.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="stylesheets/bootstrap-responsive.css" rel="stylesheet">
</head>

<body>
	<div class="container">
		<div class="left-col">
			<header id="header" class="inner"><div class='wrap'>
  <div class="profilepic">  
    <canvas id='myavatar' width="160" height="160" class='avatar' data-url="http://www.gravatar.com/avatar/c4d5adba4d840f43f89b4f2ec1724e40?size=160" >
        <img src="http://www.gravatar.com/avatar/c4d5adba4d840f43f89b4f2ec1724e40?size=160" class='avatar' />
    </canvas>
  </div>
  <h1><a href="/">Ka Ka Blog</a></h1>
  <nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/categories">Categories</a></li>
  <li><a href="/blog/about">About</a></li>
</ul>
</nav>
  <br/>
  <p>
    优秀的判断能力来自经验，但经验来自于错误的判断！
  </p>
  <h3 class="alignleft"></h3>
  <nav id="sub-nav" class="alignright">
    <div class="social">
      
      
      <a class="google" href="https://plus.google.com/112941774242932854035?rel=author" title="Google+">Google+</a>
      
      
      
      <a class="github" href="https://github.com/huxinghai1988" title="GitHub">GitHub</a>
      
      
      
      
      
      <a class="rss" href="/atom.xml" title="RSS">RSS</a>
      
    </div>
  </nav>
</div>

</header>
		</div>		
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner">


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2014-12-11T23:44:00+08:00" pubdate data-updated="true">Dec 11<span>th</span>, 2014</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/nodejs/'>nodejs</a>


</div>
		
			<span class="comments"><a href="/blog/2014/12/11/pomelo-deploy//index.html#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title"><a href="/blog/2014/12/11/pomelo-deploy/">Pomelo centOs 环境部署</a></h1>
	<div class="entry-content">
		<p>由于pomelo 依赖node-gyp这modules所以有点麻烦,安装之前配置python环境，官方推荐版本2.7</p>

<pre><code>npm config set python /usr/local/bin/python2.7

npm install -g node-gyp

npm install -g pomelo 

pomelo start -e production --daemon

//host 与 port 是master地址
pomelo stop --host 172.0.0.1 --port 4005
</code></pre>

		
		
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2014-12-10T14:11:00+08:00" pubdate data-updated="true">Dec 10<span>th</span>, 2014</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/gem/'>gem</a>


</div>
		
			<span class="comments"><a href="/blog/2014/12/10/bundle-config//index.html#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title"><a href="/blog/2014/12/10/bundle-config/">Ruby Bundle Gem的配置</a></h1>
	<div class="entry-content">
		<p>在项目里我们用的比较多的bundle install当遇到一些gem包环境问题时，在安装gem时需要加一些配置
比如：</p>

<pre><code>gem install pg -v '0.12.0' -- --with-pg-config=/usr/pgsql-9.1/bin/pg_config
</code></pre>

<p>但是当我们要把pg加入Gemfile文件时，后面的配置怎么设置，这个时候我们要用到bundle config的东西，可以在bundle
读取相应的配置, 我们可以如下设置：</p>

<pre><code>bundle config build.pg --with-pg-config=/usr/pgsql-9.1/bin/pg_config
</code></pre>

<p>bundle config 详解：</p>

<pre><code>#查看配置
bundle config

#查看某种name的配置
bundle config NAME

#设置值
bundle config NAME VALUE

#设置全局
bundle config --global NAME VALUE

#设置当前目录下
bundle config --local NAME VALUE 

#删除一个配置
bundle config --delete NAME
</code></pre>

		
		
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2014-08-21T00:41:00+08:00" pubdate data-updated="true">Aug 21<span>st</span>, 2014</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/rails/'>rails</a>


</div>
		
			<span class="comments"><a href="/blog/2014/08/21/oracle-call-stored-procedure//index.html#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title"><a href="/blog/2014/08/21/oracle-call-stored-procedure/">Rails调用oracle的存储过程</a></h1>
	<div class="entry-content">
		<p>调用方式如下：</p>

<pre><code>cursor = ActiveRecord::Base.connection.raw_connection.parse("BEGIN MYPROC(:age, :name, :fathers_age, :capital_name); END;")
cursor.bind_param(:name, 'akshay')
cursor.bind_param(:age, '20')
cursor.bind_param(:fathers_age, nil, Fixnum)
cursor.bind_param(:capital_name, nil, String, 20)
cursor.exec()
p cursor[:fathers_age], cursor[:capital_name]


require 'sequel'
db = Sequel.connect(:adapter=&gt;'oracle', :host=&gt;'localhost', :database=&gt;'db_name', :user=&gt;'test', :password=&gt;'test')
db.execute("begin MYPROC(:age, :name, :fathers_age, :capital_name); end;", {:arguments =&gt; [[20, "integer"], ["akshay", "string"], [nil, "integer"], [nil, "string"]]}) { |cursor| [cursor[3], cursor[4]] }
</code></pre>

		
		
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2014-07-28T23:39:00+08:00" pubdate data-updated="true">Jul 28<span>th</span>, 2014</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/ruby/'>ruby</a>


</div>
		
			<span class="comments"><a href="/blog/2014/07/28/rails-raise//index.html#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title"><a href="/blog/2014/07/28/rails-raise/">Ruby根据不同的异常处理不同事件</a></h1>
	<div class="entry-content">
		<p>在一个<em>class</em>里面你想根据不同的异常回调不同事件</p>

<pre><code>class NoMoneyException &lt; StandardError
end

class ValidNumberException &lt; StandardError
end

class Sale

    def self.create(options)
        obj = new(options)
        obj.validation
    end

    def validation

        raise NoMoneyException if money &gt; current_user.money
        raise ValidNumberException if number &gt; warehouse.nventory
    end
end


begin
    Sale.create({...})
rescue NoMoneyException =&gt; e
    callback ..
rescue ValidNumberException =&gt; e
    callback ..
end
</code></pre>

		
		
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2014-07-24T22:10:00+08:00" pubdate data-updated="true">Jul 24<span>th</span>, 2014</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/linux/'>linux</a>


</div>
		
			<span class="comments"><a href="/blog/2014/07/24/shell-service-dump-and-cut//index.html#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title"><a href="/blog/2014/07/24/shell-service-dump-and-cut/">两个常用的shell脚本</a></h1>
	<div class="entry-content">
		<ol>
<li><p>日志切割</p>

<pre><code> #!/bin/sh
 log_path="/home/littlefire/var/www/apps/littlefire/current/log"
 to_day=`date -d "yesterday" +"%Y%m%d"`
 cp ${log_path}/production.log ${log_path}/production_${to_day}.log
 echo "" &gt; ${log_path}/production.log
 chown littlefire:littlefire ${log_path}/production.log
 bzip2 ${log_path}/production_${to_day}.log
</code></pre></li>
<li><p>mysql数据库定时备份</p>

<pre><code> #!/bin/sh
 #
 #发送Email的话要安装 mutt与msmtp才可以

 today=`date -d "today" +"%Y%m%d"`
 path=/home/kaka/data_backup/
 filename=backup_${today}.sql
 file_path=${path}${filename}
 tar_name=${path}backup_${today}.tar.gz
 /usr/bin/mysqldump -uroot -p** database_name &gt; ${file_path}

 tar -zcvf $tar_name -C $path $filename
 rm $file_path
 find $path -mtime +6 -type f -name backup_*.tar.gz | xargs rm -rf 
 #echo "littefire data dump ${today}" | mutt -s "${today} dump data" ***@qq.com -a $tar_name
</code></pre></li>
</ol>


		
		
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2014-07-08T22:21:00+08:00" pubdate data-updated="true">Jul 8<span>th</span>, 2014</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/工具/'>工具</a>


</div>
		
			<span class="comments"><a href="/blog/2014/07/08/exceptional//index.html#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title"><a href="/blog/2014/07/08/exceptional/">异常平台 Exceptional</a></h1>
	<div class="entry-content">
		<p>visit: <a href="https://www.exceptional.io">官网</a></p>

<p>一个不错的统计项目的出错请求,而且支持多种语言，但是不是免费($9/month)</p>

<h3>Rails 使用方式</h3>

<ol>
<li><p>在Gemfile配置</p>

<pre><code> gem exceptional
</code></pre></li>
<li><p>打包</p>

<pre><code> bundle install
</code></pre></li>
<li><p>生成exceptional的配置文件</p>

<pre><code> #YOUR-API-KEY 你申请的key
 bundle exec exceptional install YOUR-API-KEY
</code></pre></li>
</ol>


		
		
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2014-06-26T14:24:00+08:00" pubdate data-updated="true">Jun 26<span>th</span>, 2014</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/工具/'>工具</a>


</div>
		
			<span class="comments"><a href="/blog/2014/06/26/ngrok//index.html#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title"><a href="/blog/2014/06/26/ngrok/">Ngrok反向代理工具</a></h1>
	<div class="entry-content">
		<p>ngrok是个款不错的工具，在我们开发中经常要用到。</p>

<p>visit: <a href="https://ngrok.com/">官网</a></p>

<h3>使用方式</h3>

<ol>
<li><p>简单的运行</p>

<pre><code> // 代理你电脑3001端口， 运行后通过http://127.0.0.1:4040查看请求状态    
 ngrok 3001
</code></pre></li>
<li><p>验证运行</p>

<pre><code> // authtoken你在官方注册，就会生成一个, authtoken只要在电脑上运行一次就可以了会
 // 记录的, 如果你验证了的话ngrok 生成的前缀域名不会被占用和变化
 ngrok -authtoken U54UzZiDLFQxyZ-Ow*** 3001
</code></pre></li>
<li><p>需要别人验证才可以浏览</p>

<pre><code> // helmet用户名, 12345密码
 ngrok -httpauth="helmet:12345" 3001
</code></pre></li>
<li><p>设置前缀域名</p>

<pre><code> ngrok -subdomain=example 3001
</code></pre></li>
<li><p>tcp代理</p>

<pre><code> ngrok -proto=tcp 22
</code></pre></li>
<li><p>指定其它服务器代理</p>

<pre><code> //为192.168.1.16服务器的3001端口代理
 ngrok 192.168.1.16:3001
</code></pre></li>
<li><p>运行多个类型服务</p>

<pre><code> // ngrok.yml配置类型如下

 tunnels:
   client:
     proto:
       https: "3000"
     auth: user:password
   c99bba1.ngrok.com:
     proto:
       http: "3000"
   ssh:
     proto:
       tcp: "22"


 // config: 配置文件路径
 // start: 运行哪几种类型服务(client, ssh c99bba1.ngrok.com)
 ngrok -log=stdout -authtoken=U54UzZiDLFQxyZ-Ow*** -config=ngrok.yml start client ssh c99bba1.ngrok.com
</code></pre></li>
</ol>


		
		
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2014-04-10T14:12:00+08:00" pubdate data-updated="true">Apr 10<span>th</span>, 2014</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/git/'>git</a>


</div>
		
			<span class="comments"><a href="/blog/2014/04/10/git-error//index.html#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title"><a href="/blog/2014/04/10/git-error/">Git 错误 Object Is Empy / Corrupt</a></h1>
	<div class="entry-content">
		<h4>问题</h4>

<p>早上上班开始工作是准备git push到远程服务器时，出现下面错误！我估计是之前的merge导致的</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  error: object file .git/objects/xx/xxx is empty
</span><span class='line'>  fatal: loose object xxx (stored in .git/objects/xx/xxx is corrupt</span></code></pre></td></tr></table></div></figure>


<h4>解决方案</h4>

<p>参考<a href="http://vincesalvino.blogspot.jp/2013/08/git-empty-files-corrupt-objects-and.html">链接</a>, 其实我就是删除空的commit就可以了</p>

<pre><code>find .git/objects/ -size 0 -exec rm -f {} \; 
</code></pre>

		
		
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2014-01-25T15:13:00+08:00" pubdate data-updated="true">Jan 25<span>th</span>, 2014</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/elasticsearch/'>elasticsearch</a>


</div>
		
			<span class="comments"><a href="/blog/2014/01/25/elasticsearch-dynamic-template//index.html#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title"><a href="/blog/2014/01/25/elasticsearch-dynamic-template/">Elasticsearch 动态加载属性的mapping</a></h1>
	<div class="entry-content">
		<p>代码示例:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>  curl -XPUT <span class="s1">&#39;localhost:9200/products&#39;</span> -d <span class="s1">&#39;{</span>
</span><span class='line'><span class="s1">    &quot;settings&quot;: {</span>
</span><span class='line'><span class="s1">      &quot;analysis&quot;: {</span>
</span><span class='line'><span class="s1">        &quot;analyzer&quot;: {</span>
</span><span class='line'><span class="s1">          &quot;pinyin_analyzer&quot;: {</span>
</span><span class='line'><span class="s1">            &quot;tokenizer&quot;: &quot;my_pinyin&quot;,</span>
</span><span class='line'><span class="s1">            &quot;filter&quot;: [&quot;standard&quot;, &quot;nGram&quot;]</span>
</span><span class='line'><span class="s1">          }</span>
</span><span class='line'><span class="s1">        },</span>
</span><span class='line'><span class="s1">        &quot;tokenizer&quot;: {</span>
</span><span class='line'><span class="s1">          &quot;my_pinyin&quot;: {</span>
</span><span class='line'><span class="s1">            &quot;type&quot;: &quot;pinyin&quot;,</span>
</span><span class='line'><span class="s1">            &quot;first_letter&quot;: &quot;prefix&quot;,</span>
</span><span class='line'><span class="s1">            &quot;padding_char&quot;: &quot;&quot;</span>
</span><span class='line'><span class="s1">          }</span>
</span><span class='line'><span class="s1">        }</span>
</span><span class='line'><span class="s1">      }</span>
</span><span class='line'><span class="s1">    },</span>
</span><span class='line'><span class="s1">    &quot;mappings&quot;: {</span>
</span><span class='line'><span class="s1">      &quot;product&quot;: {</span>
</span><span class='line'><span class="s1">        &quot;dynamic_templates&quot;: [</span>
</span><span class='line'><span class="s1">          {</span>
</span><span class='line'><span class="s1">            &quot;property_template&quot;: {</span>
</span><span class='line'><span class="s1">              &quot;path_match&quot;: &quot;properties.*&quot;,</span>
</span><span class='line'><span class="s1">              &quot;mapping&quot;: {</span>
</span><span class='line'><span class="s1">                &quot;type&quot;: &quot;multi_field&quot;,</span>
</span><span class='line'><span class="s1">                &quot;fields&quot;: {</span>
</span><span class='line'><span class="s1">                  &quot;{name}&quot;: {</span>
</span><span class='line'><span class="s1">                    &quot;type&quot;: &quot;string&quot;,</span>
</span><span class='line'><span class="s1">                    &quot;analyzer&quot; : &quot;pinyin_analyzer&quot;,</span>
</span><span class='line'><span class="s1">                    &quot;boost&quot;: 10,</span>
</span><span class='line'><span class="s1">                    &quot;store&quot;: &quot;no&quot;,</span>
</span><span class='line'><span class="s1">                    &quot;term_vector&quot;: &quot;with_positions_offsets&quot;</span>
</span><span class='line'><span class="s1">                  },</span>
</span><span class='line'><span class="s1">                  &quot;{name}_untouched&quot;: {</span>
</span><span class='line'><span class="s1">                    &quot;type&quot;: &quot;string&quot;,</span>
</span><span class='line'><span class="s1">                    &quot;index&quot;: &quot;not_analyzed&quot;</span>
</span><span class='line'><span class="s1">                  }</span>
</span><span class='line'><span class="s1">                }</span>
</span><span class='line'><span class="s1">              }</span>
</span><span class='line'><span class="s1">            }</span>
</span><span class='line'><span class="s1">          }</span>
</span><span class='line'><span class="s1">        ]</span>
</span><span class='line'><span class="s1">      }</span>
</span><span class='line'><span class="s1">    }</span>
</span><span class='line'><span class="s1">  }&#39;</span>
</span><span class='line'>
</span><span class='line'>  curl -XPOST <span class="s1">&#39;localhost:9200/products/product&#39;</span> -d <span class="s1">&#39;{name: &quot;加多宝&quot;, properties: {ping: 1} }&#39;</span>
</span><span class='line'>  curl -XPOST <span class="s1">&#39;localhost:9200/products/product&#39;</span> -d <span class="s1">&#39;{name: &quot;水杯&quot;, properties: {ge: 1} }&#39;</span>
</span><span class='line'>
</span><span class='line'>  curl -XGET <span class="s1">&#39;localhost:9200/products/product/_mapping?pretty&#39;</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-11-05T09:37:00+08:00" pubdate data-updated="true">Nov 5<span>th</span>, 2013</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/elasticsearch/'>elasticsearch</a>


</div>
		
			<span class="comments"><a href="/blog/2013/11/05/elasticsearch-script-sort//index.html#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title"><a href="/blog/2013/11/05/elasticsearch-script-sort/">Elasticsearch脚本排序</a></h1>
	<div class="entry-content">
		<p>由于自己要自定义score, 所以才会使用script来写复杂的sort</p>

<h4>javascript script 排序</h4>

<ul>
<li>安装 <a href="https://github.com/elasticsearch/elasticsearch-lang-javascript">elasticsearch-lang-javascript</a></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bin/plugin -install elasticsearch/elasticsearch-lang-javascript/1.4.0
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>写js脚本</li>
</ul>


<p>在你的配置目录下新建文件scripts/products/sort.js, 我的配置目录是<em>/etc/elasticsearch</em>,简单实例:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>  <span class="nx">doc</span><span class="p">.</span><span class="nx">_score</span><span class="p">.</span><span class="nx">value</span> <span class="o">+</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">likes</span><span class="p">.</span><span class="nx">value</span>
</span><span class='line'><span class="p">})()</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>查询</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>curl -XGET <span class="s1">&#39;http://localhost:9200/products/_search?pretty&#39;</span> -d <span class="s1">&#39;{</span>
</span><span class='line'><span class="s1">  &quot;query&quot;: {</span>
</span><span class='line'><span class="s1">    &quot;custom_score&quot;: {</span>
</span><span class='line'><span class="s1">      &quot;script&quot;: &quot;global_product&quot;,</span>
</span><span class='line'><span class="s1">      &quot;query&quot;: {</span>
</span><span class='line'><span class="s1">        &quot;filtered&quot;: {</span>
</span><span class='line'><span class="s1">          &quot;filter&quot;: {</span>
</span><span class='line'><span class="s1">            &quot;and&quot;: [</span>
</span><span class='line'><span class="s1">              {</span>
</span><span class='line'><span class="s1">                &quot;term&quot;: {</span>
</span><span class='line'><span class="s1">                  &quot;_type&quot;: &quot;product&quot;</span>
</span><span class='line'><span class="s1">                }</span>
</span><span class='line'><span class="s1">              }</span>
</span><span class='line'><span class="s1">            ]</span>
</span><span class='line'><span class="s1">          }</span>
</span><span class='line'><span class="s1">        }</span>
</span><span class='line'><span class="s1">      }</span>
</span><span class='line'><span class="s1">    }</span>
</span><span class='line'><span class="s1">  },</span>
</span><span class='line'><span class="s1">  &quot;sort&quot;: [</span>
</span><span class='line'><span class="s1">    {</span>
</span><span class='line'><span class="s1">      &quot;_score&quot;: &quot;desc&quot;</span>
</span><span class='line'><span class="s1">    }</span>
</span><span class='line'><span class="s1">  ]</span>
</span><span class='line'><span class="s1">}&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>products_sort: products是目录sort脚本文件名</p>

<h4>native script 排序</h4>

<ul>
<li><p>案例</p>

<p><a href="https://github.com/imotov/elasticsearch-native-script-example">官方example</a></p>

<p><a href="https://github.com/huxinghai1988/sort-score-script">自己写了个简单的排序</a></p></li>
<li><p>查询</p></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>curl -X GET <span class="s1">&#39;http://localhost:9200/products/_search?pretty&#39;</span> -d <span class="s1">&#39;{</span>
</span><span class='line'><span class="s1">  &quot;query&quot;: {</span>
</span><span class='line'><span class="s1">    &quot;custom_score&quot;: {</span>
</span><span class='line'><span class="s1">      &quot;script&quot;: &quot;productSort&quot;,</span>
</span><span class='line'><span class="s1">      &quot;lang&quot;: &quot;native&quot;,</span>
</span><span class='line'><span class="s1">      &quot;query&quot;: {</span>
</span><span class='line'><span class="s1">        &quot;filtered&quot;: {</span>
</span><span class='line'><span class="s1">          &quot;filter&quot;: {</span>
</span><span class='line'><span class="s1">            &quot;and&quot;: [</span>
</span><span class='line'><span class="s1">              {</span>
</span><span class='line'><span class="s1">                &quot;term&quot;: {</span>
</span><span class='line'><span class="s1">                  &quot;_type&quot;: &quot;product&quot;</span>
</span><span class='line'><span class="s1">                }</span>
</span><span class='line'><span class="s1">              }</span>
</span><span class='line'><span class="s1">            ]</span>
</span><span class='line'><span class="s1">          }</span>
</span><span class='line'><span class="s1">        }</span>
</span><span class='line'><span class="s1">      }</span>
</span><span class='line'><span class="s1">    }</span>
</span><span class='line'><span class="s1">  },</span>
</span><span class='line'><span class="s1">  &quot;sort&quot;: [</span>
</span><span class='line'><span class="s1">    {</span>
</span><span class='line'><span class="s1">      &quot;_score&quot;: &quot;desc&quot;</span>
</span><span class='line'><span class="s1">    }</span>
</span><span class='line'><span class="s1">  ]</span>
</span><span class='line'><span class="s1">}&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>单机做测试，js与native排序性能方面有差距同样的5W数据,比较一下查询速度：
  js：70ms, native: 20ms</p>

		
		
	</div>

</article>

<nav id="pagenavi">
    
    
        <a href="/blog/page/2/" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav></div>
			</div>
			<footer id="footer" class="inner">Copyright &copy; 2014

    kaka

</footer>
			<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'mbkk';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





		</div>
	</div>
</body>
</html>
