
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Ka Ka Blog</title>
	<meta name="author" content="kaka">

	
	<meta name="description" content="由于自己要自定义score, 所以才会使用script来写复杂的sort javascript script 排序 安装 elasticsearch-lang-javascript 1
bin/plugin -install elasticsearch/elasticsearch-lang- &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Ka Ka Blog" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	
	<script src="/javascripts/jquery-1.8.3.js"></script>
<script src="/javascripts/application.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="stylesheets/bootstrap-responsive.css" rel="stylesheet">
</head>

<body>
	<div class="container">
		<div class="left-col">
			<header id="header" class="inner"><div class='wrap'>
  <div class="profilepic">  
    <canvas id='myavatar' width="160" height="160" class='avatar' data-url="http://www.gravatar.com/avatar/c4d5adba4d840f43f89b4f2ec1724e40?size=160" >
        <img src="http://www.gravatar.com/avatar/c4d5adba4d840f43f89b4f2ec1724e40?size=160" class='avatar' />
    </canvas>
  </div>
  <h1><a href="/">Ka Ka Blog</a></h1>
  <nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/categories">Categories</a></li>
  <li><a href="/blog/about">About</a></li>
</ul>
</nav>
  <br/>
  <p>
    优秀的判断能力来自经验，但经验来自于错误的判断！
  </p>
  <h3 class="alignleft"></h3>
  <nav id="sub-nav" class="alignright">
    <div class="social">
      
      
      <a class="google" href="https://plus.google.com/112941774242932854035?rel=author" title="Google+">Google+</a>
      
      
      
      <a class="github" href="https://github.com/huxinghai1988" title="GitHub">GitHub</a>
      
      
      
      
      
      <a class="rss" href="/atom.xml" title="RSS">RSS</a>
      
    </div>
  </nav>
</div>

</header>
		</div>		
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner">


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-11-05T09:37:00+08:00" pubdate data-updated="true">Nov 5<span>th</span>, 2013</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/elasticsearch/'>elasticsearch</a>


</div>
		
			<span class="comments"><a href="/blog/2013/11/05/elasticsearch-script-sort//blog/page/2/index.html#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title"><a href="/blog/2013/11/05/elasticsearch-script-sort/">Elasticsearch脚本排序</a></h1>
	<div class="entry-content">
		<p>由于自己要自定义score, 所以才会使用script来写复杂的sort</p>

<h4>javascript script 排序</h4>

<ul>
<li>安装 <a href="https://github.com/elasticsearch/elasticsearch-lang-javascript">elasticsearch-lang-javascript</a></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bin/plugin -install elasticsearch/elasticsearch-lang-javascript/1.4.0
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>写js脚本</li>
</ul>


<p>在你的配置目录下新建文件scripts/products/sort.js, 我的配置目录是<em>/etc/elasticsearch</em>,简单实例:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>  <span class="nx">doc</span><span class="p">.</span><span class="nx">_score</span><span class="p">.</span><span class="nx">value</span> <span class="o">+</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">likes</span><span class="p">.</span><span class="nx">value</span>
</span><span class='line'><span class="p">})()</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>查询</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>curl -XGET <span class="s1">&#39;http://localhost:9200/products/_search?pretty&#39;</span> -d <span class="s1">&#39;{</span>
</span><span class='line'><span class="s1">  &quot;query&quot;: {</span>
</span><span class='line'><span class="s1">    &quot;custom_score&quot;: {</span>
</span><span class='line'><span class="s1">      &quot;script&quot;: &quot;global_product&quot;,</span>
</span><span class='line'><span class="s1">      &quot;query&quot;: {</span>
</span><span class='line'><span class="s1">        &quot;filtered&quot;: {</span>
</span><span class='line'><span class="s1">          &quot;filter&quot;: {</span>
</span><span class='line'><span class="s1">            &quot;and&quot;: [</span>
</span><span class='line'><span class="s1">              {</span>
</span><span class='line'><span class="s1">                &quot;term&quot;: {</span>
</span><span class='line'><span class="s1">                  &quot;_type&quot;: &quot;product&quot;</span>
</span><span class='line'><span class="s1">                }</span>
</span><span class='line'><span class="s1">              }</span>
</span><span class='line'><span class="s1">            ]</span>
</span><span class='line'><span class="s1">          }</span>
</span><span class='line'><span class="s1">        }</span>
</span><span class='line'><span class="s1">      }</span>
</span><span class='line'><span class="s1">    }</span>
</span><span class='line'><span class="s1">  },</span>
</span><span class='line'><span class="s1">  &quot;sort&quot;: [</span>
</span><span class='line'><span class="s1">    {</span>
</span><span class='line'><span class="s1">      &quot;_score&quot;: &quot;desc&quot;</span>
</span><span class='line'><span class="s1">    }</span>
</span><span class='line'><span class="s1">  ]</span>
</span><span class='line'><span class="s1">}&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>products_sort: products是目录sort脚本文件名</p>

<h4>native script 排序</h4>

<ul>
<li><p>案例</p>

<p><a href="https://github.com/imotov/elasticsearch-native-script-example">官方example</a></p>

<p><a href="https://github.com/huxinghai1988/sort-score-script">自己写了个简单的排序</a></p></li>
<li><p>查询</p></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>curl -X GET <span class="s1">&#39;http://localhost:9200/products/_search?pretty&#39;</span> -d <span class="s1">&#39;{</span>
</span><span class='line'><span class="s1">  &quot;query&quot;: {</span>
</span><span class='line'><span class="s1">    &quot;custom_score&quot;: {</span>
</span><span class='line'><span class="s1">      &quot;script&quot;: &quot;productSort&quot;,</span>
</span><span class='line'><span class="s1">      &quot;lang&quot;: &quot;native&quot;,</span>
</span><span class='line'><span class="s1">      &quot;query&quot;: {</span>
</span><span class='line'><span class="s1">        &quot;filtered&quot;: {</span>
</span><span class='line'><span class="s1">          &quot;filter&quot;: {</span>
</span><span class='line'><span class="s1">            &quot;and&quot;: [</span>
</span><span class='line'><span class="s1">              {</span>
</span><span class='line'><span class="s1">                &quot;term&quot;: {</span>
</span><span class='line'><span class="s1">                  &quot;_type&quot;: &quot;product&quot;</span>
</span><span class='line'><span class="s1">                }</span>
</span><span class='line'><span class="s1">              }</span>
</span><span class='line'><span class="s1">            ]</span>
</span><span class='line'><span class="s1">          }</span>
</span><span class='line'><span class="s1">        }</span>
</span><span class='line'><span class="s1">      }</span>
</span><span class='line'><span class="s1">    }</span>
</span><span class='line'><span class="s1">  },</span>
</span><span class='line'><span class="s1">  &quot;sort&quot;: [</span>
</span><span class='line'><span class="s1">    {</span>
</span><span class='line'><span class="s1">      &quot;_score&quot;: &quot;desc&quot;</span>
</span><span class='line'><span class="s1">    }</span>
</span><span class='line'><span class="s1">  ]</span>
</span><span class='line'><span class="s1">}&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>单机做测试，js与native排序性能方面有差距同样的5W数据,比较一下查询速度：
  js：70ms, native: 20ms</p>

		
		
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-09-25T09:18:00+08:00" pubdate data-updated="true">Sep 25<span>th</span>, 2013</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/elasticsearch/'>elasticsearch</a>


</div>
		
			<span class="comments"><a href="/blog/2013/09/25/elasticsearch-mutiple-search//blog/page/2/index.html#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title"><a href="/blog/2013/09/25/elasticsearch-mutiple-search/">Elasticsearch 多个索引查询，根据不同类型条件判定</a></h1>
	<div class="entry-content">
		<h3>CURL</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>curl -XGET <span class="s1">&#39;http://localhost:9200/indexA,indexB/_search?pretty=1&#39;</span> -d <span class="s1">&#39;{</span>
</span><span class='line'><span class="s1">&quot;query&quot; : {</span>
</span><span class='line'><span class="s1">    &quot;bool&quot;: {</span>
</span><span class='line'><span class="s1">      &quot;should&quot;: [{</span>
</span><span class='line'><span class="s1">        &quot;filtered&quot;: {</span>
</span><span class='line'><span class="s1">          &quot;filter&quot;:{</span>
</span><span class='line'><span class="s1">            &quot;and&quot;: [</span>
</span><span class='line'><span class="s1">              {</span>
</span><span class='line'><span class="s1">                &quot;range&quot;:{</span>
</span><span class='line'><span class="s1">                  &quot;start_time&quot;:{</span>
</span><span class='line'><span class="s1">                    &quot;lte&quot;: &quot;2013-09-24T00:00:00+08:00&quot;</span>
</span><span class='line'><span class="s1">                  }</span>
</span><span class='line'><span class="s1">                }</span>
</span><span class='line'><span class="s1">              },{</span>
</span><span class='line'><span class="s1">                &quot;range&quot;: {</span>
</span><span class='line'><span class="s1">                  &quot;end_time&quot;: {</span>
</span><span class='line'><span class="s1">                    &quot;gt&quot;: &quot;2013-09-24T00:00:00+08:00&quot;</span>
</span><span class='line'><span class="s1">                  }</span>
</span><span class='line'><span class="s1">                }</span>
</span><span class='line'><span class="s1">              },</span>
</span><span class='line'><span class="s1">              {</span>
</span><span class='line'><span class="s1">                &quot;term&quot;: {</span>
</span><span class='line'><span class="s1">                  &quot;_type&quot;: &quot;TypeA&quot;</span>
</span><span class='line'><span class="s1">                }</span>
</span><span class='line'><span class="s1">              }]</span>
</span><span class='line'><span class="s1">          }</span>
</span><span class='line'><span class="s1">        }</span>
</span><span class='line'><span class="s1">      },{</span>
</span><span class='line'><span class="s1">        &quot;filtered&quot;: {</span>
</span><span class='line'><span class="s1">          &quot;filter&quot;: {</span>
</span><span class='line'><span class="s1">            &quot;term&quot;: {</span>
</span><span class='line'><span class="s1">              &quot;_type&quot;: &quot;TypeB&quot;</span>
</span><span class='line'><span class="s1">            }</span>
</span><span class='line'><span class="s1">          }</span>
</span><span class='line'><span class="s1">        }</span>
</span><span class='line'><span class="s1">      }]</span>
</span><span class='line'><span class="s1">    }</span>
</span><span class='line'><span class="s1">  },</span>
</span><span class='line'><span class="s1">  &quot;sort&quot;: [</span>
</span><span class='line'><span class="s1">    {</span>
</span><span class='line'><span class="s1">      &quot;_script&quot;: {</span>
</span><span class='line'><span class="s1">        &quot;script&quot;: &quot;doc[\u0027score\u0027].value/((time()-doc[\u0027start_time_ms\u0027].value) / 3600)&quot;,</span>
</span><span class='line'><span class="s1">        &quot;type&quot;: &quot;number&quot;,</span>
</span><span class='line'><span class="s1">        &quot;order&quot;: &quot;desc&quot;</span>
</span><span class='line'><span class="s1">      },</span>
</span><span class='line'><span class="s1">      &quot;_score&quot;: {</span>
</span><span class='line'>
</span><span class='line'><span class="s1">      }</span>
</span><span class='line'><span class="s1">    }</span>
</span><span class='line'><span class="s1">  ]</span>
</span><span class='line'><span class="s1">}&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>indexA 与 indexB 索引的 TypeA与TypeB</p>

<h4>ruby gem  Tire</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Tire</span><span class="o">.</span><span class="n">search</span> <span class="o">[</span><span class="s1">&#39;indexA&#39;</span><span class="p">,</span> <span class="s1">&#39;indexB&#39;</span><span class="o">]</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">from</span> <span class="n">_from</span>
</span><span class='line'>  <span class="n">size</span> <span class="n">_size</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">query</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">boolean</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">should</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">filtered</span> <span class="k">do</span>
</span><span class='line'>          <span class="n">filter</span> <span class="ss">:range</span><span class="p">,</span> <span class="ss">:end_time</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="n">gt</span><span class="p">:</span> <span class="n">toDay</span><span class="p">}</span>
</span><span class='line'>          <span class="n">filter</span> <span class="ss">:range</span><span class="p">,</span> <span class="ss">:start_time</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="n">lte</span><span class="p">:</span> <span class="n">toDay</span><span class="p">}</span>
</span><span class='line'>          <span class="n">filter</span> <span class="ss">:term</span><span class="p">,</span> <span class="ss">:_type</span> <span class="o">=&gt;</span> <span class="s2">&quot;TypeA&quot;</span>
</span><span class='line'>          <span class="n">filter</span> <span class="ss">:term</span><span class="p">,</span> <span class="ss">:status</span> <span class="o">=&gt;</span> <span class="mi">1</span>
</span><span class='line'>          <span class="n">filter</span> <span class="ss">:terms</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;category.id&quot;</span> <span class="o">=&gt;</span> <span class="n">category_ids</span><span class="p">}</span> <span class="k">if</span> <span class="n">q</span><span class="o">[</span><span class="ss">:catalog_id</span><span class="o">].</span><span class="n">present?</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="n">should</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">filtered</span> <span class="k">do</span>
</span><span class='line'>          <span class="n">filter</span> <span class="ss">:term</span><span class="p">,</span> <span class="p">{</span><span class="ss">:_type</span> <span class="o">=&gt;</span> <span class="s2">&quot;TypeB&quot;</span><span class="p">}</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">sort</span><span class="p">(</span><span class="s2">&quot;_script&quot;</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">:script</span> <span class="o">=&gt;</span> <span class="s2">&quot;doc[&#39;score&#39;].value/((time()-doc[&#39;start_time_ms&#39;].value) / 3600)&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">:type</span>   <span class="o">=&gt;</span> <span class="s2">&quot;number&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">:order</span>  <span class="o">=&gt;</span> <span class="s2">&quot;desc&quot;</span>
</span><span class='line'>  <span class="p">},</span> <span class="s2">&quot;_score&quot;</span> <span class="o">=&gt;</span> <span class="p">{})</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-06-22T00:36:00+08:00" pubdate data-updated="true">Jun 22<span>nd</span>, 2013</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/ruby/'>ruby</a>


</div>
		
			<span class="comments"><a href="/blog/2013/06/22/ruby2-0//blog/page/2/index.html#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title"><a href="/blog/2013/06/22/ruby2-0/">Ruby 2.0三个重要特性实例收藏</a></h1>
	<div class="entry-content">
		<ul>
<li><a href="http://dev.af83.com/2012/10/19/ruby-2-0-module-prepend.html">Module#prepend</a></li>
<li><a href="http://dev.af83.com/2012/10/19/ruby-2-0-module-prepend.html">Module#refine</a></li>
<li><a href="http://dev.af83.com/2013/02/18/ruby-2-0-keyword-arguments.html">Keyword arguments</a></li>
</ul>


		
		
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-06-22T00:13:00+08:00" pubdate data-updated="true">Jun 22<span>nd</span>, 2013</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/ruby/'>ruby</a>


</div>
		
			<span class="comments"><a href="/blog/2013/06/22/requirejs-rails//blog/page/2/index.html#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title"><a href="/blog/2013/06/22/requirejs-rails/">Gem Requirejs-rails Assets Precompile 简介</a></h1>
	<div class="entry-content">
		<p>安装<a href="https://github.com/jwhitley/requirejs-rails">requirejs-rails</a>, 然后新建配置文件<code>config/requirejs.yml</code></p>

<p>requirejs.yml</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#配置单个模块，会编译一个单独的模块</span>
</span><span class='line'><span class="n">modules</span><span class="p">:</span>
</span><span class='line'>  <span class="o">-</span> <span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;mytoplevel&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#路径</span>
</span><span class='line'><span class="n">paths</span>
</span><span class='line'>  <span class="n">jquery</span><span class="p">:</span> <span class="s2">&quot;lib/jquery.js&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#设置依赖关系</span>
</span><span class='line'><span class="n">shim</span><span class="p">:</span>
</span></code></pre></td></tr></table></div></figure>


<p>其实与requirejs配置差不多，只是rails会根据requirejs.yml编译</p>

		
		
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-05-11T12:28:00+08:00" pubdate data-updated="true">May 11<span>th</span>, 2013</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/rabbitmq/'>rabbitmq</a>


</div>
		
			<span class="comments"><a href="/blog/2013/05/11/rabbitmq-install//blog/page/2/index.html#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title"><a href="/blog/2013/05/11/rabbitmq-install/">Ubuntu Rabbitmq 服务器安装过程</a></h1>
	<div class="entry-content">
		<p>rabbitmq是用于消息列队处理的,准备研究一下它来做消息处理
rabbitmq是用Erlang开发的,所有安装之前要部署Erlang环境</p>

<h4>Erlang部署</h4>

<pre><code>wget https://elearning.erlang-solutions.com/binaries/sources/otp_src_R16B.tar.gz
tar xvzf otp_src_R16B.tar.gz
cd otp_src_R16B
./configure
make &amp;&amp; make install
</code></pre>

<h4>Rabbitmq部署</h4>

<p><a href="http://www.rabbitmq.com/install-debian.html">官方安装文档</a></p>

<ol>
<li><p>添加公共key</p>

<p> wget http://www.rabbitmq.com/rabbitmq-signing-key-public.asc</p>

<p> sudo apt-key add rabbitmq-signing-key-public.asc</p></li>
<li><p>安装</p>

<p> sudo apt-get install rabbitmq-server</p></li>
</ol>


<p><a href="http://www.rabbitmq.com/configure.html">官方配置文档</a>配置文件路径在<code>/etc/rabbitmq/</code></p>

<h4>启动rabbitmq_management管理</h4>

<pre><code>cd /usr/lib/rabbitmq/lib/rabbitmq_server-2.7.1/sbin
sudo ./rabbitmq-plugins enable rabbitmq_management
</code></pre>

<p>然后浏览地址<code>http://server-name:55672/</code>, 官方说3.0以下版本端口是55672</p>

		
		
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-05-03T23:48:00+08:00" pubdate data-updated="true">May 3<span>rd</span>, 2013</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/javascript/'>javascript</a>


</div>
		
			<span class="comments"><a href="/blog/2013/05/03/post-message//blog/page/2/index.html#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title"><a href="/blog/2013/05/03/post-message/">postMessage 跨域通讯</a></h1>
	<div class="entry-content">
		<p>不相同的域可以相互通讯, 例如iframe与页面进行通讯, <a href='https://github.com/daepark/postmessage'>postMessage</a>是个封装不错的包<br /></p>

<p>简单实例解释</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'>  <span class="c1">//在iframe 绑定频道</span>
</span><span class='line'>  <span class="nx">pm</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s2">&quot;message1&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">));</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">//发送消息</span>
</span><span class='line'>  <span class="nx">pm</span><span class="p">({</span>
</span><span class='line'>    <span class="c1">//给那个iframe</span>
</span><span class='line'>    <span class="nx">target</span><span class="o">:</span> <span class="nb">window</span><span class="p">.</span><span class="nx">frames</span><span class="p">[</span><span class="s2">&quot;example1&quot;</span><span class="p">],</span>
</span><span class='line'>    <span class="c1">//频道</span>
</span><span class='line'>    <span class="nx">type</span><span class="o">:</span><span class="s2">&quot;message1&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="c1">//内容</span>
</span><span class='line'>    <span class="nx">data</span><span class="o">:</span><span class="p">{</span><span class="nx">hello</span><span class="o">:</span><span class="s2">&quot;world&quot;</span><span class="p">}</span>
</span><span class='line'>  <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-04-19T22:59:00+08:00" pubdate data-updated="true">Apr 19<span>th</span>, 2013</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/javascript/'>javascript</a>


</div>
		
			<span class="comments"><a href="/blog/2013/04/19/requirejs//blog/page/2/index.html#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title"><a href="/blog/2013/04/19/requirejs/">Requirejs 使用</a></h1>
	<div class="entry-content">
		<p><a href='http://requirejs.org/'>requirejs</a>是一个管理js模块加载与依赖包，可以不使用script标签来加载js文件<br />
1.引用requirejs文件<br /></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="o">&lt;</span><span class="nx">script</span> <span class="nx">data</span><span class="o">-</span><span class="nx">main</span><span class="o">=</span><span class="s2">&quot;scripts/main&quot;</span> <span class="nx">src</span><span class="o">=</span><span class="s2">&quot;scripts/require.js&quot;</span><span class="o">&gt;&lt;</span><span class="err">/script&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>2.配置, <a href='http://requirejs.org/docs/api.html#config'>更多配置</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">requirejs</span><span class="p">.</span><span class="nx">config</span><span class="p">({</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//默认加载模块路径</span>
</span><span class='line'>    <span class="nx">baseUrl</span><span class="o">:</span> <span class="s2">&quot;js/lib&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//指定模块的路径</span>
</span><span class='line'>    <span class="nx">paths</span><span class="o">:</span><span class="p">{</span>
</span><span class='line'>        <span class="c1">//前面别名， 后面路径</span>
</span><span class='line'>        <span class="s2">&quot;jquery&quot;</span> <span class="o">:</span> <span class="s2">&quot;js/core/jquery.2.0.js&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s2">&quot;backbone&quot;</span> <span class="o">:</span> <span class="s2">&quot;js/core/backbone0.9.js&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s2">&quot;underscore&quot;</span><span class="o">:</span> <span class="s2">&quot;js/core/underscore.js&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//设置依赖关系</span>
</span><span class='line'>    <span class="nx">shim</span><span class="o">:</span><span class="p">{</span>
</span><span class='line'>        <span class="nx">backbone</span><span class="o">:</span><span class="p">{</span>
</span><span class='line'>            <span class="nx">deps</span><span class="o">:</span><span class="p">[</span><span class="s2">&quot;underscore&quot;</span><span class="p">,</span> <span class="s2">&quot;jquery&quot;</span><span class="p">],</span>
</span><span class='line'>            <span class="c1">//可以使用全局别名</span>
</span><span class='line'>            <span class="nx">exports</span><span class="o">:</span> <span class="s2">&quot;Backbone&quot;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>3.使用</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// js/dom.js</span>
</span><span class='line'><span class="nx">define</span><span class="p">([</span><span class="s2">&quot;backbone&quot;</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">Backbone</span><span class="p">){</span>
</span><span class='line'>    <span class="nx">LoginView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
</span><span class='line'>        <span class="p">...</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">LoginView</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'>
</span><span class='line'><span class="nx">require</span><span class="p">([</span><span class="s2">&quot;js/dom&quot;</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">LoginView</span><span class="p">){</span>
</span><span class='line'>    <span class="k">new</span> <span class="nx">LoginView</span><span class="p">(</span>
</span><span class='line'>        <span class="p">...</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-04-12T23:35:00+08:00" pubdate data-updated="true">Apr 12<span>th</span>, 2013</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/backbone/'>backbone</a>


</div>
		
			<span class="comments"><a href="/blog/2013/04/12/backbone-updated//blog/page/2/index.html#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title"><a href="/blog/2013/04/12/backbone-updated/">backbone升级0.9.9版本，添加两个方法listenTo与stopListening</a></h1>
	<div class="entry-content">
		<p>listenTo用于绑定事件，stopListening关闭绑定事件了<br />
它们与on有什么不同的呢！这里做个例子<br /></p>

<pre>
  var Todo = Backbone.Model.extend({
    ...
  })
   
  var todo = new Todo()
  var appView = Backbone.View.extend({
    initialize: function(){
      this.listenTo(todo, "change:name", this.edit_attr)
    },
    edit_attr: function(){
      this.$(".name").html(this.model.get('name'))
    }
  })

  var app_view = new appView()
  app_view.remove()  
</pre>


<p>当我们<code>app_view.remove()</code>删除之后会自动执行<code>stopListening</code>方法关注绑定事件<br />
<code>todo</code>模型就不会有这个视图绑的事件了，如果<br /></p>

<pre>
  this.listenTo(todo, "change:name", this.edit_attr)
</pre>


<p>改用这种绑定方式</p>

<pre>
  todo.on("change:name", this.edit_attr, this)
</pre>


<p><code>app_view.remove()</code>删除之后，todo模型还是会有这个绑定的事件<br />
当然也可以用off来处理，但是现在有listenTo就不用做特别的处理了。</p>

		
		
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-03-20T22:58:00+08:00" pubdate data-updated="true">Mar 20<span>th</span>, 2013</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/php/'>php</a>


</div>
		
			<span class="comments"><a href="/blog/2013/03/20/captcha-generate//blog/page/2/index.html#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title"><a href="/blog/2013/03/20/captcha-generate/">使用php的Codeigniter框架 生图片验证码遇到的问题</a></h1>
	<div class="entry-content">
		<p>根据官方网站介绍，可以使用<code>captcha</code>实现,实现方式如下<br /></p>

<pre>    

  /*
  * 控制加载
  */
  $this->load->helper('captcha');  
  ...

  /*
  * 方法
  */
  $vals = array(        
    'img_path' => './captcha/',
    'img_url' => 'http://localhost/finance/captcha/',
    'font_path' => "./system/fonts/texb.ttf"
  );

  $data["img_code"] = create_captcha($vals);
  ...
</pre>


<p>结果没有反应，然后进入<code>create_captcha</code>方法调试，发现在<code> extension_loaded('gd')</code><br/>
过滤了，经过google 搜索是没有加载gd库，然后在网上查加载gd库,配置一下php.ini文件如下:</p>

<p><code>
  extension=php_gd2.dll
</code>
由于我是安装wamp服务管理软件在里面选择一下，然后重启apache服务就ok了</p>

		
		
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-03-01T23:24:00+08:00" pubdate data-updated="true">Mar 1<span>st</span>, 2013</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/部署/'>部署</a>


</div>
		
			<span class="comments"><a href="/blog/2013/03/01/capistrano-deploy//blog/page/2/index.html#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title"><a href="/blog/2013/03/01/capistrano-deploy/">centOS Rails + Nginx + Rvm + Capistrano + Passenger + Git 部署</a></h1>
	<div class="entry-content">
		<p>所谓自动化部署<br />
步聚如下：<br /></p>

<p>1.在项目gemfile文件加入如下gem包，然后<code>bundle</code><br /></p>

<pre>
    gem rvm-capistrano
    gem passenger
</pre>


<p>2.然后执行<code>capify .</code>命令，生成两个文件路径如下<br /></p>

<pre>
    config/deploy.rb

    Capfile
</pre>


<p>3.配置deploy.rb文件，如下<br /></p>

<pre>
    #设置应用名称
    set :application, "dom1"
    #服务登陆用户与密码
    set :user,"root"
    set :password,"321654"
    #项目仓库地址
    set :repository,  "git@github.com:huxinghai1988/capistrano_dom"
    #服务地址
    set :domain,"192.168.2.27"

    #设置伪登陆
    default_run_options[:pty] = true 

    #设置权限
    set :use_sudo,false
    #使用git更新代码也可以使用svn
    set :scm, "git"
    #git用户名
    set :scm_user,"root"
    #git密码
    set :scm_passphrase,"123456"
    #部署服务器位置
    set :deploy_to,"/var/www/#{application}"
    #部署分支
    set :branch, "master"
    #产品模式
    set :rails_env, 'production'

    # Or: `accurev`, `bzr`, `cvs`, `darcs`, `git`, `mercurial`, `perforce`, `subversion` or `none`


    role :web, domain                          # Your HTTP server, Apache/etc
    role :app, domain                         # This may be the same as your `Web` server
    role :db,  domain, :primary => true      # This is where Rails migrations will run

    #rvm 安装路径与 ruby版本
    set :rvm_path,"/usr/local/rvm"
    set :rvm_bin_path,"/usr/local/rvm/bin"
    set :rvm_ruby_string,'ruby-1.9.2'

    require 'rvm/capistrano'
    require 'bundler/capistrano'

    #deploy:setup前安装rvm与ruby
    before 'deploy:setup' do
        run 'echo insecure > ~/.curlrc', :shell => 'bash -c'
        find_and_execute_task "rvm:install_rvm"
        find_and_execute_task 'rvm:install_ruby'
    end

    #可以在发布后设置上传目录
    after 'deploy' do
        run "mkdir -p #{release_path}/public/uploads"        
        run "ln -nfs #{shared_path}/user #{release_path}/public/uploads"
        run "chown -R nobody:nobody #{release_path}/public/uploads"    
    end


    load 'deploy/assets'
</pre>


<p>4.执行<code>cap deploy:setup</code>可以运行<code>cap -T</code>查看所有命令</p>

<p>5.安装完之后，执行<code>cap deploy</code>部署</p>

<p>6.成功部署后，到服务器安装nginx与passenger<br /></p>

<pre>
    passenger-install-nginx-module
</pre>


<p>出现如下选择<br /></p>

<pre>
    1.Yes: download, compile and install Nginx for me. (recommended)
    The easiest way to get started. A stock Nginx 1.0.10 with Passenger
    support, but with no other additional third party modules, will be
    installed for you to a directory of your choice.

    2.No: I want to customize my Nginx installation. (for advanced users)
    Choose this if you want to compile Nginx with more third party modules
    besides Passenger, or if you need to pass additional options to Nginx's
    'configure' script. This installer will 1) ask you for the location of
    the Nginx source code, 2) run the 'configure' script according to your
    instructions, and 3) run 'make install'.

    Whichever you choose, if you already have an existing Nginx configuration file,
    then it will be preserved.

    Enter your choice (1 or 2) or press Ctrl-C to abort: 这里建议选择1

    当询问nginx的安装路径的时候，个人建议安装默认，安回车就行了
    Please specify a prefix directory [/opt/nginx]: 
</pre>


<p>当安装完成后，会在console中提示如何配置Nginx<br />
Passenger会自动帮你将下面两行添加到Nginx的配置文件中/opt/nginx/conf/nginx.conf（很人性化）<br /></p>

<pre>
    http {
        ...
        passenger_root /Users/Daniel/.rvm/gems/ruby-1.9.3-p374/gems/passenger-3.0.19;
        passenger_ruby /Users/Daniel/.rvm/wrappers/ruby-1.9.3-p374/ruby;
        ...
    }
</pre>


<p>6.设置nginx.conf的静态目录,root参数指定到项目的public目录</p>

<pre>
    server {
        listen 80;
        server_name www.yourhost.com;
        root /var/www/dom1/current/public;   # <--- be sure to point to 'public'!
        passenger_enabled on;
    }
</pre>


<p>整体nginx.conf配置如下：<br /></p>

<pre>
    user  root;
    worker_processes  1;

    events {
        worker_connections  1024;
    }


http {
    passenger_root /Users/Daniel/.rvm/gems/ruby-1.9.3-p374/gems/passenger-3.0.19;
    passenger_ruby /Users/Daniel/.rvm/wrappers/ruby-1.9.3-p374/ruby;

    autoindex on;
    include       mime.types;
    default_type  application/octet-stream;

    sendfile        on;

    keepalive_timeout  65;
    server {
        listen       80;
        server_name  test1.local;
        passenger_enabled on;
        rails_env production;

        location / {
            passenger_enabled on;
            rails_env production;
            root   /var/www/dom1/current/public;
            index  index.html index.htm;
        }

        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }

    }

}
</pre>


<p>7.重新运行</p>

<pre>
    killall nginx           #杀死所有nginx进程
    /opt/nginx/sbin/nginx   #启动nginx
</pre>


		
		
	</div>

</article>

<nav id="pagenavi">
    
        <a href="/" class="prev">Prev</a>
    
    
        <a href="/blog/page/3/" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav></div>
			</div>
			<footer id="footer" class="inner">Copyright &copy; 2015

    kaka

</footer>
			<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'mbkk';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





		</div>
	</div>
</body>
</html>
